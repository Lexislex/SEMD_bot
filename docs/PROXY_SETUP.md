# Настройка прокси для SEMD Bot

Этот документ описывает, как настроить прокси-сервер для бота, чтобы обойти блокировку IP при подключении к `nsi.rosminzdrav.ru`.

## Содержание

- [Когда нужен прокси](#когда-нужен-прокси)
- [Быстрый старт](#быстрый-старт)
- [Использование бесплатных прокси](#использование-бесплатных-прокси)
- [Использование платных прокси](#использование-платных-прокси)
- [Настройка .env файла](#настройка-env-файла)
- [Проверка работы](#проверка-работы)
- [Решение проблем](#решение-проблем)

## Когда нужен прокси

Прокси-сервер необходим, если:
- Ваш IP адрес заблокирован сервером `nsi.rosminzdrav.ru`
- Вы получаете ошибки подключения при запросах к API ФНСИ
- Вы хотите скрыть свой реальный IP адрес

## Быстрый старт

### 1. Найти рабочий прокси

Используйте встроенный скрипт для поиска бесплатных прокси:

```bash
poetry run python scripts/fetch_free_proxies.py
```

Скрипт найдет и проверит бесплатные прокси, выведет работающие варианты.

### 2. Настроить .env файл

Добавьте найденный прокси в ваш `.env` файл:

```env
PROXY_ENABLED=true
PROXY_TYPE=http
PROXY_HOST=123.45.67.89
PROXY_PORT=8080
```

### 3. Перезапустить бота

```bash
# Остановить бота
sudo systemctl stop SEMD_bot

# Запустить бота
sudo systemctl start SEMD_bot

# Проверить статус
sudo systemctl status SEMD_bot
```

## Использование бесплатных прокси

### Автоматический поиск

Скрипт `fetch_free_proxies.py` поддерживает различные опции:

```bash
# Базовое использование
poetry run python scripts/fetch_free_proxies.py

# С пользовательскими параметрами
poetry run python scripts/fetch_free_proxies.py \
  --test-url https://nsi.rosminzdrav.ru \
  --timeout 15 \
  --max-proxies 100 \
  --proxy-type http \
  --workers 20
```

**Параметры:**
- `--test-url` - URL для проверки прокси (по умолчанию: https://httpbin.org/ip)
- `--timeout` - таймаут проверки в секундах (по умолчанию: 10)
- `--max-proxies` - максимальное количество прокси для проверки (по умолчанию: 50)
- `--proxy-type` - тип прокси: http, https, socks5 (по умолчанию: http)
- `--workers` - количество потоков для проверки (по умолчанию: 10)

### Источники бесплатных прокси

Скрипт использует следующие источники:
1. **ProxyScrape** (https://proxyscrape.com) - автоматически обновляемый список
2. **Geonode** (https://geonode.com) - проверенные прокси

### Недостатки бесплатных прокси

- Низкая надежность (часто перестают работать)
- Медленная скорость
- Могут быть небезопасными
- Требуют частого обновления

**Рекомендация:** Используйте бесплатные прокси только для тестирования.

## Использование платных прокси

### Рекомендуемые сервисы

Для production использования рекомендуются платные сервисы:

#### 1. Proxy6.net (Российские прокси)
- Сайт: https://proxy6.net
- Цена: от ~30₽/месяц
- Типы: HTTP, HTTPS, SOCKS5

**Настройка:**
1. Зарегистрируйтесь на сайте
2. Купите прокси (рекомендуется российский IPv4)
3. Получите данные прокси в личном кабинете
4. Добавьте в `.env`:

```env
PROXY_ENABLED=true
PROXY_TYPE=http
PROXY_HOST=123.45.67.89
PROXY_PORT=8080
PROXY_USER=username  # если требуется
PROXY_PASS=password  # если требуется
```

#### 2. ProxyLine.net
- Сайт: https://proxyline.net
- Цена: от 100₽/месяц
- Высокая стабильность

#### 3. Proxy-Seller
- Сайт: https://proxy-seller.ru
- Цена: от 50₽/месяц
- Индивидуальные прокси

## Настройка .env файла

### Базовая конфигурация (без авторизации)

```env
# Включить прокси
PROXY_ENABLED=true

# Тип прокси (http, https, socks5)
PROXY_TYPE=http

# Адрес и порт
PROXY_HOST=123.45.67.89
PROXY_PORT=8080
```

### Конфигурация с авторизацией

```env
# Включить прокси
PROXY_ENABLED=true

# Тип прокси
PROXY_TYPE=http

# Адрес и порт
PROXY_HOST=proxy.example.com
PROXY_PORT=8080

# Авторизация
PROXY_USER=your_username
PROXY_PASS=your_password
```

### Отключение прокси

```env
# Отключить прокси
PROXY_ENABLED=false
```

## Проверка работы

### 1. Проверка подключения через прокси

Запустите скрипт проверки с вашим прокси:

```bash
poetry run python scripts/fetch_free_proxies.py \
  --test-url https://nsi.rosminzdrav.ru \
  --timeout 30
```

### 2. Проверка логов бота

```bash
# Просмотр логов
sudo journalctl -u SEMD_bot -f

# Или файл логов
tail -f logs/bot.log
```

Ищите сообщения:
- `Используется прокси: http://123.45.67.89:8080` - прокси активен
- `Успешно получен ответ от ФНСИ` - запрос успешен

### 3. Тестирование запроса к API

Создайте тестовый скрипт `test_proxy.py`:

```python
from config import get_config
from services.fnsi_client import get_version

cfg = get_config()

# Проверка конфигурации прокси
if cfg.proxy.enabled:
    print(f"Прокси включен: {cfg.proxy.host}:{cfg.proxy.port}")
else:
    print("Прокси отключен")

# Тестовый запрос
try:
    result = get_version("1.2.643.5.1.13.13.99.2.114")
    print(f"Успешно! Версия: {result['version']}")
except Exception as e:
    print(f"Ошибка: {e}")
```

Запустите:
```bash
poetry run python test_proxy.py
```

## Решение проблем

### Прокси не работает

1. **Проверьте настройки в .env:**
   ```bash
   cat .env | grep PROXY
   ```

2. **Убедитесь, что прокси активен:**
   - Используйте скрипт `fetch_free_proxies.py` для проверки
   - Попробуйте другой прокси

3. **Проверьте тип прокси:**
   - Для HTTPS сайтов используйте HTTPS или SOCKS5 прокси
   - HTTP прокси может не работать с HTTPS

### Медленная работа

1. **Выберите более быстрый прокси:**
   ```bash
   poetry run python scripts/fetch_free_proxies.py --max-proxies 100
   ```
   Выберите прокси с наименьшим временем ответа

2. **Используйте географически близкий прокси:**
   - Для `nsi.rosminzdrav.ru` лучше использовать российские прокси

3. **Перейдите на платные прокси:**
   - Они обычно быстрее и стабильнее

### Ошибки SSL/сертификата

1. **Проверьте наличие сертификата:**
   ```bash
   ls -la env/crts/rosminzdrav.crt
   ```

2. **Попробуйте другой тип прокси:**
   - HTTPS вместо HTTP
   - SOCKS5 вместо HTTP/HTTPS

### Прокси быстро перестает работать

Для бесплатных прокси это нормально:

1. **Автоматизируйте обновление прокси:**
   - Создайте cron задачу для запуска `fetch_free_proxies.py`
   - Автоматически обновляйте `.env` файл

2. **Используйте ротацию прокси:**
   - Настройте несколько прокси
   - Меняйте их при ошибках

3. **Перейдите на платные прокси:**
   - Они работают стабильно
   - Не требуют частого обновления

## Дополнительные рекомендации

### Безопасность

1. **Не используйте бесплатные прокси для передачи чувствительных данных**
2. **Используйте HTTPS прокси для шифрования трафика**
3. **Регулярно меняйте прокси**
4. **Не сохраняйте пароли от прокси в публичных репозиториях**

### Производительность

1. **Используйте несколько прокси для распределения нагрузки**
2. **Выбирайте прокси с минимальной задержкой**
3. **Используйте прокси в той же стране, что и целевой сервер**

### Мониторинг

1. **Регулярно проверяйте работоспособность прокси**
2. **Следите за логами бота**
3. **Настройте уведомления об ошибках подключения**

## Полезные ссылки

- [ProxyScrape API](https://proxyscrape.com/free-proxy-list)
- [Geonode API](https://geonode.com/free-proxy-list)
- [Документация requests](https://docs.python-requests.org/en/latest/user/advanced/#proxies)
- [Список платных прокси-сервисов](https://github.com/clarketm/proxy-list)

---

**Поддержка:** Если у вас возникли проблемы, создайте issue в репозитории проекта.
